<?xml version="1.0" encoding="utf-8"?>
<!--
 
Action buttons (Previous/Save/Next) can be shown "top", "bottom" or "both":
<stage name="type" action_buttons="both">
  <component><field ref="type" required="yes" /></component>
</stage>
 
-->
<workflow xmlns="http://eprints.org/ep3/workflow" xmlns:epc="http://eprints.org/ep3/control">
  <flow>
    <epc:choose required_by="recollect" id="recollect_choose">
      <epc:when test="type = 'data_collection'">
         
        <stage ref="data_collection"/>
        <stage ref="data_collection_additional"/>
        <stage ref="recollect_files"/>
       <!-- <epc:if test="$STAFF_ONLY = 'TRUE'">
            <stage ref="subjects"/>
        </epc:if> -->
      </epc:when>
      <epc:otherwise>
        <stage ref="type"/>
        <stage ref="files"/>
        <stage ref="core"/>
      <!--  <stage ref="subjects"/> -->
      </epc:otherwise>
    </epc:choose>
  </flow>
  <stage name="type">
    <component>
      <field ref="type" required="yes"/>
    </component>
  </stage>
  <stage name="files">
    <component type="Upload" show_help="always"/>
    <component type="Documents">
      <field ref="formatdesc"/>
      <field ref="content"/>
      <field ref="security"/>
      <field ref="date_embargo"/>
       
      <field ref="format"/>
      <field ref="license"/>
       
<!--  <field ref="relation" /> -->
<!--  <field ref="language" /> -->
    </component>
  </stage>
  <stage name="core">
    <component>
      <field ref="title" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/title_duplicates" input_lookup_params="id={eprintid}&amp;dataset=eprint&amp;field=title"/>
    </component>
    <component>
      <field ref="abstract"/>
    </component>
    <epc:if test="type = 'monograph'">
      <component>
        <field ref="monograph_type" required="yes"/>
      </component>
    </epc:if>
    <epc:if test="type = 'thesis'">
      <component>
        <field ref="thesis_type" required="yes"/>
      </component>
    </epc:if>
    <epc:if test="type = 'conference_item'">
      <component>
        <field ref="pres_type" required="yes"/>
      </component>
    </epc:if>
    <epc:if test="type = 'composition'">
      <component>
        <field ref="composition_type" required="yes"/>
      </component>
    </epc:if>
    <epc:if test="type = 'dataset'">
      <component>
        <field ref="data_type" required="yes"/>
      </component>
    </epc:if>
    <epc:choose>
      <epc:when test="type.one_of('book','book_section')">
        <component>
          <field ref="creators" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name"/>
        </component>
        <component>
          <field ref="corp_creators"/>
        </component>
        <component>
          <field ref="editors" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name"/>
        </component>
      </epc:when>
      <epc:otherwise>
        <component>
          <field ref="creators" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name"/>
        </component>
        <component>
          <field ref="corp_creators"/>
        </component>
      </epc:otherwise>
    </epc:choose>
<!-- This field is much more complicated than creators, but here if you need it.
    <component><field ref="contributors" /></component>
-->
    <epc:if test="type = 'exhibition'">
      <component collapse="yes">
        <field ref="exhibitors"/>
      </component>
      <component>
        <field ref="num_pieces"/>
      </component>
    </epc:if>
    <epc:if test="type = 'composition'">
      <component collapse="yes">
        <field ref="producers"/>
      </component>
      <component collapse="yes">
        <field ref="conductors"/>
      </component>
      <component collapse="yes">
        <field ref="accompaniment"/>
      </component>
      <component collapse="yes">
        <field ref="lyricists"/>
      </component>
    </epc:if>
    <epc:if test="type = 'performance'">
      <component collapse="yes">
        <field ref="producers"/>
      </component>
      <component collapse="yes">
        <field ref="conductors"/>
      </component>
      <component collapse="yes">
        <field ref="accompaniment"/>
      </component>
    </epc:if>
    <component>
      <field ref="divisions"/>
    </component>
    <component type="Field::Multi">
      <title>Publication Details</title>
      <epc:if test="type != 'patent' ">
        <epc:if test="type.one_of('book_section', 'book', 'article', 'conference_item')">
          <field ref="refereed" required="yes"/>
        </epc:if>
        <!--<epc:if test="type != 'artefact' and type != 'exhibition'">
          <field ref="ispublished" required="yes"/>
        </epc:if>-->
      </epc:if>
      <epc:if test="type = 'patent'">
        <field ref="date" required="yes"/>
        <field ref="date_type" required="yes"/>
        <field ref="official_url"/>
        <field ref="patent_applicant" required="yes"/>
        <field ref="id_number" required="yes"/>
        <field ref="pages"/>
      </epc:if>
      <epc:if test="type = 'monograph'">
        <field ref="institution"/>
        <field ref="department"/>
        <field ref="place_of_pub"/>
        <field ref="publisher" required="yes"/>
        <field ref="id_number"/>
        <field ref="pages"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'book'">
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="place_of_pub"/>
        <field ref="publisher" required="yes"/>
        <field ref="pages"/>
        <field ref="series"/>
        <field ref="volume"/>
        <field ref="number"/>
        <field ref="isbn"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'other'">
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
        <field ref="place_of_pub"/>
        <field ref="publisher" required="yes"/>
        <field ref="id_number"/>
      </epc:if>
      <epc:if test="type = 'book_section'">
        <field ref="pagerange"/>
        <field ref="book_title" required="yes"/>
        <field ref="volume"/>
        <field ref="place_of_pub"/>
        <field ref="publisher" required="yes"/>
        <field ref="pages"/>
        <field ref="id_number"/>
        <field ref="series"/>
        <field ref="number"/>
        <field ref="isbn"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'thesis'">
        <field ref="date" required="yes"/>
        <field ref="date_type" required="yes"/>
        <field ref="official_url"/>
        <field ref="institution" required="yes"/>
        <field ref="department" required="yes"/>
        <field ref="pages"/>
      </epc:if>
      <epc:if test="type = 'conference_item'">
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="pagerange"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'article'">
        <field ref="publication" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/journal_by_name"/>
        <field ref="issn" input_lookup_url="{$config{rel_cgipath}}/users/lookup/journal_by_issn"/>
        <field ref="publisher"/>
        <field ref="official_url"/>
        <field ref="volume"/>
        <field ref="number"/>
        <field ref="pagerange"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="id_number"/>
      </epc:if>
      <epc:if test="type = 'artefact'">
        <field ref="output_media"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'exhibition'">
        <field ref="output_media"/>
        <field ref="isbn"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'composition'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'performance'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'image'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'video'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'audio'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'dataset'">
        <field ref="output_media"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'experiment'">
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <epc:if test="type = 'teaching_resource'">
        <field ref="copyright_holders"/>
        <field ref="publisher"/>
        <field ref="date"/>
        <field ref="date_type"/>
        <field ref="official_url"/>
      </epc:if>
      <field ref="related_url"/>
    </component>
    <component>
      <field ref="funders"/>
    </component>
    <component>
      <field ref="projects"/>
    </component>
    <epc:if test="type = 'teaching_resource'">
      <component type="Field::Multi">
        <title>Pedagogic Details</title>
        <field ref="pedagogic_type"/>
        <field ref="completion_time"/>
        <field ref="task_purpose"/>
        <field ref="skill_areas"/>
        <field ref="learning_level"/>
      </component>
    </epc:if>
    <epc:if test="type.one_of( 'exhibition', 'performance' )">
      <component type="Field::Multi">
        <title>Venue Details</title>
        <field ref="event_title"/>
        <field ref="event_location"/>
        <field ref="event_dates"/>
      </component>
    </epc:if>
    <epc:if test="type = 'conference_item'">
      <component type="Field::Multi">
        <title>Event Details</title>
        <field ref="event_title" input_lookup_url="{$config{rel_cgipath}}/users/lookup/event_by_name" required="yes"/>
        <field ref="event_type" required="yes"/>
        <field ref="event_location"/>
        <field ref="event_dates"/>
      </component>
    </epc:if>
<!-- This field is not really intended to be edited directly by users.
    <component><field ref="relation"/></component>
-->
    <component collapse="yes">
      <field ref="contact_email"/>
    </component>
    <component collapse="yes">
      <field ref="referencetext"/>
    </component>
    <component collapse="yes">
      <field ref="keywords"/>
    </component>
    <component collapse="yes">
      <field ref="note"/>
    </component>
    <component collapse="yes">
      <field ref="suggestions"/>
    </component>
  </stage>
<!--  <stage name="subjects">
    <component type="Field::Subject">
      <field ref="subjects" required="yes"/>
    </component>
  </stage> -->
   
   
   
  <!--####################################################################################
      ################################# RECOLLECT WORKFLOW HERE ##########################
      ####################################################################################-->
   
   
   
   
 <stage name="recollect_files" required_by="recollect">
    <component type="Upload" show_help="always"/>
    <component type="Documents">
      <field ref="formatdesc"  required="yes"/>
      <field ref="content" set_name="recollect_content"/>
      <field ref="security"/>     
      <field ref="date_embargo"/>
      <field ref="license" required="yes"/>
      <field ref="format"/>
      <field ref="retention_period"/>
<!--  <field ref="relation" /> -->
<!--  <field ref="language" /> -->
    </component>
  </stage>
  <stage name="data_collection" required_by="recollect">
        <!--<component type="XHTML">
          <h1>Describe your dataset</h1>
        </component>-->
         
    <!--SJ: added section headings-->
    <component surround="None" type="XHTML">
    <h2>Tell us about your data</h2>
    </component>
 
    <component surround="Default_lshtm">
      <field ref="title" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/title_duplicates" input_lookup_params="id={eprintid}&amp;dataset=eprint&amp;field=title"/>
    </component>
      <component surround="Default_lshtm" collapse="yes">
      <field ref="alt_title"/>
    </component>
    <component surround="Default_lshtm" show_help="always">
      <field ref="abstract" required="yes"/>
    </component>
     
    <!--SJ: moved-->
     <component surround="Default_lshtm">
      <field ref="keywords" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/keywords" />
    </component>
    <!--end of moved-->
     
    <!--SJ: moved-->
    <component surround="Default_lshtm_large">
      <!--<title>Time period covered in dataset</title>-->
      <field ref="collection_date"/>
    </component>
    <!--end of moved-->
     
    <!--SJ: moved-->
    <component type="Field::Multi" surround="Default_lshtm_large">
      <title>Date information</title>
      <field ref="date_type" required="yes"/>
      <field ref="date" required="yes"/>
    </component>
    <!--end of moved-->
 
    <!--SJ: moved-->
      <component surround="Default_lshtm">
      <field ref="collection_mode"/>
    </component>
    <!--end of moved-->
 
    <!--SJ: moved-->
    <component collapse="yes" surround="Default_lshtm">
      <field ref="collection_method"/>
    </component>
    <!--end of moved-->
 
    <!--SJ: moved
    <component type="Field::Multi_map" show_help="always" collapse="no">
      <title>Geographic location</title>
      <help>Enter if applicable the Longitude and Latitude values of a theoretical geographic bounding rectangle that would cover the region in which your data were collected. You can use</help>
      <field ref="bounding_box"/>
    </component>
    end of moved-->
             
    <!--SJ: moved-->
    <epc:if test="!$item{bounding_box_east_edge}">
    <component surround="Default_lshtm">
      <field ref="geographic_cover"/>
    </component>
    </epc:if>
    <!--end of moved-->
 
    <!--SJ: moved-->
     <component collapse="yes" surround="Default_lshtm">
      <field ref="language"/>
    </component>
    <!--end of moved-->
 
    <!--SJ: moved-->
    <component surround="Default_lshtm">
      <field ref="note"/>
    </component>
    <!--end of moved-->
 
    
  </stage>
   
   
  <stage name="data_collection_additional" required_by="recollect">
   
    <!--SJ: added section headings-->
    <component surround="None" type="XHTML">
    <h2>Tell us about your project team and associated publications</h2>
    </component>
     
    <!--SJ: moved-->
    <component surround="Default_lshtm_large">
      <!--<field ref="creators" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name"/>-->
      <field ref="creators" required="yes" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name_and_lshtmid"/>
    </component>
    <!--end of moved-->
     
    <!--SJ: moved-->
    <component collapse="yes" surround="Default_lshtm_large">
      <field ref="contributors" input_lookup_url="{$config{rel_cgipath}}/users/lookup/name_and_lshtmid"/>
    </component>g
    <!--end of moved-->  
     
    <!--SJ: moved-->
    <component surround="Default_lshtm">
      <field ref="contact_email" required="yes"/>
    </component>
    <!--end of moved-->  
 
    <!--SJ: moved-->
    <component surround="Default_lshtm_large">
        <field ref="repo_link" input_lookup_url="{$config{rel_cgipath}}{$config{repo_link}{lookup_script}}" input_lookup_params="id={eprintid}"/>
    </component>
    <!--end of moved-->  
 
    <!--SJ: moved-->
    <component collaspe="yes" surround="Default_lshtm">
      <field ref="related_resources"/>
    </component>
    <!--end of moved-->  
     
    <!--SJ: added section headings-->
    <component surround="None" type="XHTML">
    <h2>Tell us about your project and faculty</h2>
    </component>
     
     
    <!--SJ: moved
    <component type="Field::SelectCollection"><field ref="relation" /></component>
    end of moved-->
     
    <component type="Field::Multi" surround="Default_lshtm_large">
      <title>Project details</title>
      <field ref="projects" input_lookup_url="{$config{rel_cgipath}}/users/lookup/projects" input_lookup_params="_type=collection"/>
      <field ref="grant"/>
      <field ref="funders" input_lookup_url="{$config{perl_url}}/users/lookup/simple_file" input_lookup_params="file=funders"/>
      <!--<field ref="grant"/>-->
    </component>
 
    <!--SJ: moved-->
    <component surround="Default_lshtm_large">
      <field ref="corp_creators" required="yes"/>
    </component>
    <!--end of moved-->
 
    <!--SJ: moved-->
    <component surround="Default_lshtm_large">
      <field ref="divisions"/>
    </component>  
    <component surround="Default_lshtm_large">
      <field ref="research_centre"/>
    </component> 
    <component surround="Default_lshtm_large">
      <field ref="research_groups"/>
    </component> 
    <!--end of moved-->
     
    <!--SJ: moved--> 
     <component surround="Default_lshtm">
      <field ref="copyright_holders" required="yes"/>
    </component>   
    <!--end of moved-->
     
    <!--SJ: moved--> 
    <component type="Field::Multi" surround="Default_lshtm_large">
       <title>Publication details</title>
      <field ref="publisher"/>
      <field ref="place_of_pub"/>
    <!--  <field ref="official_url"/> -->
    </component>
    <!--end of moved-->
 
   <!--
 <component>
      <field ref="keywords" required="yes"/>
    </component>
    
    <comment>
        removed for now
        <epc:if test="$STAFF_ONLY = 'TRUE'"><component show_help="always"><field ref="doi" required="yes"/></component></epc:if></comment>
    <component>
      <field ref="data_type" required="yes" input_lookup_url="{$config{perl_url}}/users/lookup/simple_file" input_lookup_params="file=data_type"/>
    </component>
      
    <component collapse="yes">
      <field ref="legal_ethical"/>
    </component>
    <component collapse="yes">
      <field ref="provenance"/>
    </component>
    <component collapse="yes">
      <field ref="suggestions"/>
    </component>
-->
 
  </stage>
</workflow>
